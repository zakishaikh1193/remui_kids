{{!
    Elementary Dashboard Template (Grades 1-3)
    
    This template provides a kid-friendly dashboard for elementary students
    with simplified navigation and engaging visuals.
}}

<!-- Include Elementary Sidebar -->
{{> theme_remui_kids/elementary_sidebar}}

<div class="elementary-dashboard">
    {{#is_mycourses_page}}
    <!-- My Courses Page Content -->
    <div class="mycourses-page-content">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fa fa-book"></i>
                My Courses
            </h1>
            <p class="page-subtitle">Explore and manage your enrolled courses</p>
        </div>

        <!-- Courses Grid -->
        {{#has_student_courses}}
        <div class="courses-grid">
            {{#student_courses}}
            <div class="course-card" data-course-id="{{id}}">
                <!-- Course Image -->
                <div class="course-image-container">
                    {{#courseimage}}
                    <img src="{{courseimage}}" alt="{{fullname}}" class="course-image">
                    {{/courseimage}}
                    {{^courseimage}}
                    <div class="course-image-placeholder">
                        <i class="fa fa-book"></i>
                    </div>
                    {{/courseimage}}
                    
                    <!-- Course Category Badge -->
                    <div class="course-category-badge">{{categoryname}}</div>
                    
                    <!-- Course Progress Overlay -->
                    <div class="course-progress-overlay">
                        <div class="progress-circle">
                            <span class="progress-percentage">{{progress_percentage}}%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Course Content -->
                <div class="course-content">
                    <h3 class="course-title">{{fullname}}</h3>
                    <p class="course-summary">{{#summary}}{{summary}}{{/summary}}{{^summary}}No description available{{/summary}}</p>
                    
                    <!-- Course Progress Bar -->
                    <div class="course-progress-section">
                        <div class="progress-header">
                            <span class="progress-label">Progress</span>
                            <span class="progress-percentage">{{progress_percentage}}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{progress_percentage}}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Course Statistics -->
                    <div class="course-stats">
                        <div class="stat-item">
                            <i class="fa fa-tasks"></i>
                            <span>{{completed_activities}}/{{total_activities}} Activities</span>
                        </div>
                        <div class="stat-item">
                            <i class="fa fa-clock-o"></i>
                            <span>{{grade_level}}</span>
                        </div>
                    </div>
                    
                    <!-- Course Actions -->
                    <div class="course-actions">
                        {{#completed}}
                        <a href="{{courseurl}}" class="course-button primary">
                            <i class="fa fa-refresh"></i>
                            Review Course
                        </a>
                        {{/completed}}
                        {{^completed}}
                        {{#in_progress}}
                        <a href="{{courseurl}}" class="course-button primary">
                            <i class="fa fa-play"></i>
                            Continue Learning
                        </a>
                        {{/in_progress}}
                        {{^in_progress}}
                        <a href="{{courseurl}}" class="course-button primary">
                            <i class="fa fa-play"></i>
                            Start Course
                        </a>
                        {{/in_progress}}
                        {{/completed}}
                    </div>
                </div>
            </div>
            {{/student_courses}}
        </div>
        {{/has_student_courses}}
        
        {{^has_student_courses}}
        <!-- No Courses Message -->
        <div class="no-courses-message">
            <div class="no-courses-icon">
                <i class="fa fa-book-open"></i>
            </div>
            <h3>No Courses Available</h3>
            <p>You don't have any enrolled courses yet. Contact your teacher or administrator to get enrolled in courses.</p>
            <a href="{{{dashboardurl}}}" class="back-to-dashboard">
                <i class="fa fa-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>
        {{/has_student_courses}}
    </div>
    {{/is_mycourses_page}}
    
    {{^is_mycourses_page}}
    <!-- Grade 1-3 Statistics Cards -->
    {{#elementary_stats}}
    <div class="row mb-4">
        <div class="col-12">
            <div class="elementary-stats-container">
                <!-- Total Courses Card -->
                <div class="elementary-stat-card courses-card" id="courses-card">
                    <div class="stat-icon-container">
                        <i class="fa fa-book stat-icon"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="total-courses-count">{{total_courses}}</div>
                        <div class="stat-label">Courses</div>
                        <div class="stat-updated" id="courses-updated" style="font-size: 10px; color: #666; margin-top: 5px;">
                            Last updated: {{#elementary_stats}}{{#last_updated}}{{last_updated}}{{/last_updated}}{{/elementary_stats}}
                        </div>
                    </div>
                    <div class="stat-refresh-btn" onclick="refreshCourseCount()" style="position: absolute; top: 10px; right: 10px; cursor: pointer; color: #666; font-size: 14px;" title="Refresh Course Count">
                        <i class="fa fa-refresh" id="courses-refresh-icon"></i>
                    </div>
                </div>
                
                <!-- Lessons Completed Card -->
                <div class="elementary-stat-card lessons-card">
                    <div class="stat-icon-container">
                        <i class="fa fa-check-circle stat-icon"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{lessons_completed}}</div>
                        <div class="stat-label">Lessons Done</div>
                    </div>
                </div>
                
                <!-- Activities Completed Card -->
                <div class="elementary-stat-card activities-card">
                    <div class="stat-icon-container">
                        <i class="fa fa-trophy stat-icon"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{activities_completed}}</div>
                        <div class="stat-label">Activities Done</div>
                    </div>
                </div>
                
                <!-- Overall Progress Card -->
                <div class="elementary-stat-card progress-card">
                    <div class="stat-icon-container">
                        <i class="fa fa-chart-line stat-icon"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{overall_progress}}%</div>
                        <div class="stat-label">Overall Progress</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{/elementary_stats}}

    <!-- My Courses Section -->
    {{#has_elementary_courses}}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="sections-section-title">
                <i class="fa fa-book"></i> My Courses
            </h3>
            <div class="elementary-courses-container">
                {{#elementary_courses}}
                <div class="elementary-course-card enhanced" data-course-id="{{id}}">
                    <!-- Course Header with Image -->
                    <div class="course-image-container">
                        {{#courseimage}}
                        <img src="{{courseimage}}" alt="{{fullname}}" class="course-image">
                        {{/courseimage}}
                        {{^courseimage}}
                        <div class="course-image-placeholder">
                            <i class="fa fa-book"></i>
                        </div>
                        {{/courseimage}}
                        
                        <!-- Course Level Badge -->
                        <div class="course-level-badge">{{categoryname}}</div>
                        
                        <!-- Course Status Indicator -->
                        <div class="course-status-indicator {{#completed}}completed{{/completed}}{{^completed}}{{#in_progress}}in-progress{{/in_progress}}{{^in_progress}}not-started{{/in_progress}}{{/completed}}">
                            <i class="fa {{#completed}}fa-check-circle{{/completed}}{{^completed}}{{#in_progress}}fa-play-circle{{/in_progress}}{{^in_progress}}fa-circle-o{{/in_progress}}{{/completed}}"></i>
                        </div>
                    </div>
                    
                    <!-- Course Content -->
                    <div class="course-content">
                        <!-- Course Title and Grade -->
                        <div class="course-header">
                            <h4 class="course-title">{{fullname}}</h4>
                            <span class="course-grade">{{grade_level}}</span>
                        </div>
                        
                        <!-- Course Summary -->
                        <p class="course-summary">{{summary}}</p>
                        
                        <!-- Progress Section -->
                        <div class="course-progress-section">
                            <div class="progress-header">
                                <span class="progress-label">Your Progress</span>
                                <span class="progress-percentage">{{progress_percentage}}%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {{progress_percentage}}%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Course Statistics -->
                        <div class="course-stats-grid">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fa fa-book"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number">{{completed_sections}}/{{total_sections}}</div>
                                    <div class="stat-label">Lessons</div>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fa fa-tasks"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number">{{completed_activities}}/{{total_activities}}</div>
                                    <div class="stat-label">Activities</div>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fa fa-clock-o"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number">{{estimated_time}}</div>
                                    <div class="stat-label">Minutes</div>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fa fa-star"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number">{{points_earned}}</div>
                                    <div class="stat-label">Points</div>
                                </div>
                            </div>
                        </div>
                                                        
                        <!-- Course Actions -->
                        <div class="course-actions">
                            {{#completed}}
                            <a href="{{courseurl}}" class="course-button completed">
                                <i class="fa fa-check"></i> Review Course
                            </a>
                            {{/completed}}
                            {{^completed}}
                            {{#in_progress}}
                            <a href="{{courseurl}}" class="course-button in-progress">
                                <i class="fa fa-play"></i> Continue Learning
                            </a>
                            {{/in_progress}}
                            {{^in_progress}}
                            <a href="{{courseurl}}" class="course-button not-started">
                                <i class="fa fa-play"></i> Start Course
                            </a>
                            {{/in_progress}}
                            {{/completed}}
                            
                            <!-- Course Details Button -->
                            <button class="course-details-btn" onclick="toggleCourseDetails({{id}})">
                                <i class="fa fa-info-circle"></i>
                            </button>
                        </div>
                        
                        <!-- Course Details Panel (Hidden by default) -->
                        <div class="course-details-panel" id="details-{{id}}" style="display: none;">
                            <div class="details-content">
                                <h6>Course Details</h6>
                                <div class="detail-item">
                                    <strong>Instructor:</strong> {{instructor_name}}
                                </div>
                                <div class="detail-item">
                                    <strong>Start Date:</strong> {{start_date}}
                                </div>
                                <div class="detail-item">
                                    <strong>Last Accessed:</strong> {{last_accessed}}
                                </div>
                                <div class="detail-item">
                                    <strong>Next Activity:</strong> {{next_activity}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {{/elementary_courses}}
            </div>
            
            <!-- View All Courses Button -->
            {{#show_view_all_button}}
            <div class="text-center mt-3">
                <a href="{{config.wwwroot}}/theme/remui_kids/my_courses.php" class="btn btn-outline-primary view-all-courses-btn">
                    <i class="fa fa-th-large"></i> View All Courses ({{total_courses_count}})
                </a>
            </div>
            {{/show_view_all_button}}
        </div>
    </div>
    {{/has_elementary_courses}}
    
    <!-- Active Lessons Section -->
    {{#has_elementary_active_sections}}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="sections-section-title">
                <i class="fa fa-list-alt"></i> Active Lessons
            </h3>
            <div class="elementary-sections-container">
                {{#elementary_active_sections}}
                <div class="elementary-section-card">
                    <div class="section-content">
                        <div class="section-header">
                            <h4 class="section-title">{{name}}</h4>
                            <span class="section-course">{{coursename}}</span>
                        </div>
                        
                        {{#summary}}
                        <p class="section-summary">{{summary}}</p>
                        {{/summary}}
                        
                        <!-- Progress Bar -->
                        <div class="section-progress-section">
                            <div class="progress-bar-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {{progress_percentage}}%"></div>
                                </div>
                                <span class="progress-percentage">{{progress_percentage}}%</span>
                            </div>
                        </div>
                        
                        <!-- Section Stats -->
                        <div class="section-stats">
                            <div class="section-stat-item">
                                <i class="fa fa-check-circle" style="color: #27ae60;"></i>
                                <span>{{completed_activities}}/{{total_activities}} activities</span>
                            </div>
                        </div>
                        
                        <a href="{{courseurl}}" class="section-button">
                            <i class="fa fa-play"></i> Continue Section
                        </a>
                    </div>
                </div>
                {{/elementary_active_sections}}
            </div>
        </div>
    </div>
    {{/has_elementary_active_sections}}
    
    <!-- Active Activities Section -->
    {{#has_elementary_active_lessons}}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="lessons-section-title">
                <i class="fa fa-gamepad"></i> Active Activities
            </h3>
            <div class="elementary-lessons-container">
                {{#elementary_active_lessons}}
                <a href="{{url}}" class="elementary-lesson-card" data-status="{{status}}">
                    <div class="lesson-icon-container" style="background-color: {{color}};">
                        <i class="fa {{icon}}"></i>
                    </div>
                    <div class="lesson-name">{{name}}</div>
                    <div class="lesson-course">{{coursename}}</div>
                    {{#description}}
                    <div class="lesson-description">{{description}}</div>
                    {{/description}}
                </a>
                {{/elementary_active_lessons}}
            </div>
        </div>
    </div>
    {{/has_elementary_active_lessons}}
    {{/is_mycourses_page}}
    
</div>

<script>
// Elementary Dashboard JavaScript Functions

// Real-time course count update function
function refreshCourseCount() {
    console.log('refreshCourseCount called');
    const refreshIcon = document.getElementById('courses-refresh-icon');
    const coursesCount = document.getElementById('total-courses-count');
    const coursesUpdated = document.getElementById('courses-updated');

    if (!refreshIcon || !coursesCount || !coursesUpdated) {
        console.error('Required elements not found:', {refreshIcon, coursesCount, coursesUpdated});
        return;
    }

    // Show loading state
    refreshIcon.classList.add('fa-spin');
    console.log('Fetching data from: {{config.wwwroot}}/theme/remui_kids/tests/test_ajax.php');

    // Fetch real-time data
    fetch('{{config.wwwroot}}/theme/remui_kids/tests/test_ajax.php')
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.text();
        })
        .then(text => {
            try {
                const data = JSON.parse(text);
                if (data.status === 'success') {
                    // Update the count with animation
                    animateCountUpdate(coursesCount, data.total_courses);
                    coursesUpdated.textContent = 'Last updated: ' + data.timestamp;

                    // Show success feedback
                    showUpdateFeedback('courses-card', 'success');
                } else {
                    console.error('API Error:', data);
                    showUpdateFeedback('courses-card', 'error');
                }
            } catch (parseError) {
                console.error('JSON Parse Error:', parseError);
                console.error('Response text:', text);
                showUpdateFeedback('courses-card', 'error');
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            showUpdateFeedback('courses-card', 'error');
        })
        .finally(() => {
            // Remove loading state
            refreshIcon.classList.remove('fa-spin');
        });
}

function animateCountUpdate(element, newValue) {
    const currentValue = parseInt(element.textContent) || 0;
    const increment = newValue > currentValue ? 1 : -1;
    const duration = 1000; // 1 second
    const steps = Math.abs(newValue - currentValue);
    const stepDuration = duration / steps;

    let currentStep = 0;
    const timer = setInterval(() => {
        currentStep++;
        const newDisplayValue = currentValue + (increment * currentStep);
        element.textContent = newDisplayValue;

        if (currentStep >= steps) {
            clearInterval(timer);
            element.textContent = newValue;
        }
    }, stepDuration);
}

function showUpdateFeedback(cardId, type) {
    const card = document.getElementById(cardId);
    const feedback = document.createElement('div');
    feedback.className = `update-feedback ${type}`;
    feedback.textContent = type === 'success' ? '✓ Updated' : '✗ Error';
    feedback.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${type === 'success' ? '#4CAF50' : '#f44336'};
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
    `;

    card.style.position = 'relative';
    card.appendChild(feedback);

    // Fade in
    setTimeout(() => feedback.style.opacity = '1', 10);

    // Fade out and remove
    setTimeout(() => {
        feedback.style.opacity = '0';
        setTimeout(() => card.removeChild(feedback), 300);
    }, 2000);
}

// Auto-refresh course count every 30 seconds
setInterval(refreshCourseCount, 30000);

// Enhanced Course Cards Functionality
function toggleCourseDetails(courseId) {
    const detailsPanel = document.getElementById('details-' + courseId);
    const detailsBtn = document.querySelector(`[onclick="toggleCourseDetails(${courseId})"]`);
    
    if (detailsPanel.style.display === 'none' || detailsPanel.style.display === '') {
        detailsPanel.style.display = 'block';
        detailsBtn.innerHTML = '<i class="fa fa-times"></i>';
        detailsBtn.classList.add('active');
    } else {
        detailsPanel.style.display = 'none';
        detailsBtn.innerHTML = '<i class="fa fa-info-circle"></i>';
        detailsBtn.classList.remove('active');
    }
}

// Course Card Animations and Interactions
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to course cards
    const courseCards = document.querySelectorAll('.elementary-course-card.enhanced');
    
    courseCards.forEach(card => {
        // Add entrance animation
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, Math.random() * 300);
        
        // Add hover effects
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
        });
    });
    
    // Animate progress bars
    const progressBars = document.querySelectorAll('.progress-fill');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 500);
    });
    
    // Add click animations to buttons
    const courseButtons = document.querySelectorAll('.course-button');
    courseButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
        });
    });
});
</script>

