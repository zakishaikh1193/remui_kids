{{!
    Custom Dashboard Template for remui_kids theme
    
    This template provides different dashboard layouts based on user cohorts:
    - Elementary (Grades 1-3)
    - Middle School (Grades 4-7) 
    - High School (Grades 8-12)
    - Default (fallback)
}}

{{> theme_remui_kids/common_start}}

{{#custom_dashboard}}
<!-- Custom Dashboard Header -->
<div class="custom-dashboard-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="dashboard-greeting mb-2">
                    {{hello_message}}
                </h1>
                <p class="dashboard-subtitle mb-0">
                    {{#user_cohort_name}}
                        Welcome to your {{user_cohort_name}} learning space!
                    {{/user_cohort_name}}
                    {{^user_cohort_name}}
                        Welcome to your learning space!
                    {{/user_cohort_name}}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="dashboard-badge">
                    <i class="fa fa-star"></i>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Cohort-specific content -->
{{#dashboard_type}}
    {{#elementary}}
        <div class="elementary-dashboard">
            <!-- Grade 1-3 Statistics Cards -->
            {{#elementary_stats}}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="elementary-stats-container">
                        <!-- Total Courses Card -->
                        <div class="elementary-stat-card courses-card" id="courses-card">
                            <div class="stat-icon-container">
                                <i class="fa fa-book stat-icon"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="total-courses-count">{{total_courses}}</div>
                                <div class="stat-label">Courses</div>
                                <div class="stat-updated" id="courses-updated" style="font-size: 10px; color: #666; margin-top: 5px;">
                                    Last updated: {{#elementary_stats}}{{#last_updated}}{{last_updated}}{{/last_updated}}{{/elementary_stats}}
                                </div>
                            </div>
                            <div class="stat-refresh-btn" onclick="refreshCourseCount()" style="position: absolute; top: 10px; right: 10px; cursor: pointer; color: #666; font-size: 14px;" title="Refresh Course Count">
                                <i class="fa fa-refresh" id="courses-refresh-icon"></i>
                            </div>
                        </div>
                        
                        <!-- Lessons Completed Card -->
                        <div class="elementary-stat-card lessons-card">
                            <div class="stat-icon-container">
                                <i class="fa fa-check-circle stat-icon"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">{{lessons_completed}}</div>
                                <div class="stat-label">Lessons Done</div>
                            </div>
                        </div>
                        
                        <!-- Activities Completed Card -->
                        <div class="elementary-stat-card activities-card">
                            <div class="stat-icon-container">
                                <i class="fa fa-trophy stat-icon"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">{{activities_completed}}</div>
                                <div class="stat-label">Activities Done</div>
                            </div>
                        </div>
                        
                        <!-- Overall Progress Card -->
                        <div class="elementary-stat-card progress-card">
                            <div class="stat-icon-container">
                                <i class="fa fa-chart-line stat-icon"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">{{overall_progress}}%</div>
                                <div class="stat-label">Overall Progress</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {{/elementary_stats}}

            <!-- My Courses Section -->
            {{#has_elementary_courses}}
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="courses-section-title">
                        <i class="fa fa-book"></i> My Courses
                    </h3>
                    <div class="elementary-courses-container">
                        {{#elementary_courses}}
                        <div class="elementary-course-card">
                            <div class="course-image-container">
                                {{#courseimage}}
                                <img src="{{courseimage}}" alt="{{fullname}}" class="course-image">
                                {{/courseimage}}
                                {{^courseimage}}
                                <div class="course-image-placeholder">
                                    <i class="fa fa-book"></i>
                                </div>
                                {{/courseimage}}
                                <div class="course-level-badge">{{categoryname}}</div>
                            </div>
                            <div class="course-content">
                                <h4 class="course-title">{{fullname}}</h4>
                                <p class="course-summary">{{summary}}</p>
                                
                                <!-- Progress Bar -->
                                <div class="course-progress-section">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: {{progress_percentage}}%"></div>
                                        </div>
                                        <span class="progress-percentage">{{progress_percentage}}%</span>
                                    </div>
                                </div>
                                
                                <!-- Course Stats -->
                                <div class="course-stats">
                                    <div class="course-stat-item">
                                        <i class="fa fa-book" style="color: black;"></i>
                                        <span>{{completed_sections}}/{{total_sections}} lessons</span>
                                    </div>
                                    <div class="course-stat-item">
                                        <i class="fa fa-clock-o"></i>
                                        <span>{{duration}}</span>
                                    </div>
                                </div>
                                
                                <a href="{{courseurl}}" class="course-button">
                                    <i class="fa fa-play"></i> Continue Learning
                                </a>
                            </div>
                        </div>
                        {{/elementary_courses}}
                    </div>
                    
                    <!-- View All Courses Button -->
                    {{#show_view_all_button}}
                    <div class="text-center mt-3">
                        <a href="/my/courses.php" class="btn btn-outline-primary view-all-courses-btn">
                            <i class="fa fa-th-large"></i> View All Courses ({{total_courses_count}})
                        </a>
                    </div>
                    {{/show_view_all_button}}
                </div>
            </div>
            {{/has_elementary_courses}}
            
            <!-- Active Sections Section -->
            {{#has_elementary_active_sections}}
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="sections-section-title">
                        <i class="fa fa-list-alt"></i> Active Sections
                    </h3>
                    <div class="elementary-sections-container">
                        {{#elementary_active_sections}}
                        <div class="elementary-section-card">
                            <div class="section-content">
                                <div class="section-header">
                                    <h4 class="section-title">{{name}}</h4>
                                    <span class="section-course">{{coursename}}</span>
                                </div>
                                
                                {{#summary}}
                                <p class="section-summary">{{summary}}</p>
                                {{/summary}}
                                
                                <!-- Progress Bar -->
                                <div class="section-progress-section">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: {{progress_percentage}}%"></div>
                                        </div>
                                        <span class="progress-percentage">{{progress_percentage}}%</span>
                                    </div>
                                </div>
                                
                                <!-- Section Stats -->
                                <div class="section-stats">
                                    <div class="section-stat-item">
                                        <i class="fa fa-check-circle" style="color: #27ae60;"></i>
                                        <span>{{completed_activities}}/{{total_activities}} activities</span>
                                    </div>
                                </div>
                                
                                <a href="{{courseurl}}" class="section-button">
                                    <i class="fa fa-play"></i> Continue Section
                                </a>
                            </div>
                        </div>
                        {{/elementary_active_sections}}
                    </div>
                </div>
            </div>
            {{/has_elementary_active_sections}}
            
            <!-- Active Lessons Section -->
            {{#has_elementary_active_lessons}}
            <div class="row mb-4">
                <div class="col-12">
                    <h3 class="lessons-section-title">
                        <i class="fa fa-gamepad"></i> Active Lessons
                    </h3>
                    <div class="elementary-lessons-container">
                        {{#elementary_active_lessons}}
                        <a href="{{url}}" class="elementary-lesson-card" data-status="{{status}}">
                            <div class="lesson-icon-container" style="background-color: {{color}};">
                                <i class="fa {{icon}}"></i>
                            </div>
                            <div class="lesson-name">{{name}}</div>
                            <div class="lesson-course">{{coursename}}</div>
                            {{#description}}
                            <div class="lesson-description">{{description}}</div>
                            {{/description}}
                        </a>
                        {{/elementary_active_lessons}}
                    </div>
                </div>
            </div>
            {{/has_elementary_active_lessons}}
            
        </div>
    {{/elementary}}
    
    {{#middle}}
        <div class="middle-dashboard">
            <!-- Top Statistics Bar -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="middle-stats-container">
                        <div class="middle-stat-card" id="middle-courses-card">
                            <div class="stat-content">
                                <div class="stat-title">Active Courses</div>
                                <div class="stat-number" id="middle-total-courses-count">{{middle_stats.total_courses}}</div>
                                <div class="stat-subtext">2 in progress</div>
                                <div class="stat-trend">+12% this week</div>
                                <div class="stat-updated" id="middle-courses-updated" style="font-size: 10px; color: #666; margin-top: 5px;">
                                    Last updated: {{#middle_stats}}{{#last_updated}}{{last_updated}}{{/last_updated}}{{/middle_stats}}
                                </div>
                            </div>
                            <div class="stat-icon-container blue">
                                <i class="fa fa-book"></i>
                            </div>
                            <div class="stat-refresh-btn" onclick="refreshMiddleCourseCount()" style="position: absolute; top: 10px; right: 10px; cursor: pointer; color: #666; font-size: 14px;">
                                <i class="fa fa-refresh" id="middle-courses-refresh-icon"></i>
                            </div>
                        </div>
                        <div class="middle-stat-card">
                            <div class="stat-content">
                                <div class="stat-title">Lessons Completed</div>
                                <div class="stat-number">{{middle_stats.lessons_completed}}</div>
                                <div class="stat-subtext">this month</div>
                                <div class="stat-trend">+8% this week</div>
                            </div>
                            <div class="stat-icon-container green">
                                <i class="fa fa-bullseye"></i>
                            </div>
                        </div>
                        <div class="middle-stat-card">
                            <div class="stat-content">
                                <div class="stat-title">Study Time</div>
                                <div class="stat-number">24h</div>
                                <div class="stat-subtext">this week</div>
                                <div class="stat-trend">+5% this week</div>
                            </div>
                            <div class="stat-icon-container purple">
                                <i class="fa fa-clock-o"></i>
                            </div>
                        </div>
                        <div class="middle-stat-card">
                            <div class="stat-content">
                                <div class="stat-title">Achievements</div>
                                <div class="stat-number">12</div>
                                <div class="stat-subtext">total earned</div>
                                <div class="stat-trend">+3% this week</div>
                            </div>
                            <div class="stat-icon-container orange">
                                <i class="fa fa-trophy"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="row">
                <!-- Left Content Area -->
                <div class="col-lg-8">
                    <!-- My Courses Section -->
                    {{#has_middle_courses}}
                    <div class="middle-courses-section">
                        <div class="section-header">
                            <h3 class="section-title">My Courses</h3>
                            <a href="/my/courses.php" class="view-all-link">View All ></a>
                        </div>
                        <div class="course-carousel-container">
                            <button class="carousel-btn prev-btn" onclick="changeCourse(-1)">
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <div class="course-carousel">
                                {{#middle_courses}}
                                <div class="middle-course-card" data-course-index="{{@index}}">
                                    <div class="course-image-container">
                                        {{#courseimage}}
                                        <img src="{{courseimage}}" alt="{{fullname}}" class="course-image">
                                        {{/courseimage}}
                                        {{^courseimage}}
                                        <div class="course-image-placeholder">
                                            <i class="fa fa-book"></i>
                                        </div>
                                        {{/courseimage}}
                                        <div class="course-level-badge">Beginner</div>
                                    </div>
                                    
                                    <div class="course-content">
                                        <h4 class="course-title">{{fullname}}</h4>
                                        <p class="course-summary">{{#summary}}{{summary}}{{/summary}}{{^summary}}No description available{{/summary}}</p>
                                        
                                        <!-- Progress Bar -->
                                        <div class="course-progress-section">
                                            <div class="progress-label">Progress {{progress_percentage}}%</div>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: {{progress_percentage}}%"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Course Stats -->
                                        <div class="course-stats">
                                            <div class="course-stat-item">
                                                <i class="fa fa-book"></i>
                                                <span>{{total_sections}}/{{total_sections}} lessons</span>
                                            </div>
                                        </div>
                                        
                                            <div class="course-status">not started</div>
                                            
                                            <div class="course-buttons">
                                                <a href="{{courseurl}}" class="course-button primary">
                                                    <i class="fa fa-play"></i> Continue Learning
                                                </a>
                                                <button class="course-button secondary preview-btn" onclick="openPreviewModal({{id}}, '{{fullname}}')">
                                                    <i class="fa fa-eye"></i> Preview
                                                </button>
                                            </div>
                                    </div>
                                </div>
                                {{/middle_courses}}
                            </div>
                            <button class="carousel-btn next-btn" onclick="changeCourse(1)">
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="course-indicators">
                            {{#middle_courses}}
                            <span class="indicator" data-course-index="{{@index}}" onclick="goToCourse({{@index}})"></span>
                            {{/middle_courses}}
                        </div>
                    </div>
                    {{/has_middle_courses}}
                    
                    <!-- Current Lessons Section -->
                    {{#has_middle_active_lessons}}
                    <div class="current-lessons-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fa fa-clock-o"></i> Current Lessons
                            </h3>
                            <p class="section-subtitle">Continue your learning journey</p>
                            <a href="#" class="view-all-link">View All ></a>
                        </div>
                        <div class="current-lessons-container">
                            {{#middle_active_lessons}}
                            <div class="current-lesson-card">
                                <div class="lesson-image">
                                    <div class="lesson-placeholder">
                                        <i class="fa fa-chalkboard"></i>
                                    </div>
                                </div>
                                <div class="lesson-content">
                                    <h5 class="lesson-title">{{name}}</h5>
                                    <p class="lesson-course">{{coursename}}</p>
                                </div>
                            </div>
                            {{/middle_active_lessons}}
                        </div>
                    </div>
                    {{/has_middle_active_lessons}}
                </div>
                
                <!-- Right Sidebar -->
                <div class="col-lg-4">
                    <div class="middle-sidebar">
                        <!-- Quick Stats -->
                        <div class="sidebar-section">
                            <h4 class="sidebar-title">Quick Stats</h4>
                            <div class="quick-stats-list">
                                <div class="quick-stat-item">
                                    <i class="fa fa-book"></i>
                                    <span>Courses Enrolled {{middle_stats.total_courses}}</span>
                                </div>
                                <div class="quick-stat-item">
                                    <i class="fa fa-check-circle"></i>
                                    <span>Lessons Completed {{middle_stats.lessons_completed}}</span>
                                </div>
                                <div class="quick-stat-item">
                                    <i class="fa fa-tasks"></i>
                                    <span>Pending Activities {{middle_stats.activities_completed}}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Achievements -->
                        <div class="sidebar-section">
                            <h4 class="sidebar-title">Achievements</h4>
                            <div class="achievements-content">
                                <div class="achievement-goal">Best: 5 Goal: 7</div>
                                <div class="achievements-grid">
                                    <div class="achievement-item">
                                        <i class="fa fa-fire"></i>
                                        <span>5 Streaks</span>
                                    </div>
                                    <div class="achievement-item">
                                        <i class="fa fa-star"></i>
                                        <span>850 Points</span>
                                    </div>
                                    <div class="achievement-item">
                                        <i class="fa fa-coins"></i>
                                        <span>1250 Coins</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Your Schedule -->
                        <div class="sidebar-section">
                            <h4 class="sidebar-title">
                                <i class="fa fa-clock-o"></i> Your Schedule
                                <a href="#" class="view-full-link">View Full Calendar ></a>
                            </h4>
                            <p class="schedule-subtitle">Next 7 Days</p>
                            <div class="calendar-week">
                                <div class="calendar-day">
                                    <div class="day-name">MON</div>
                                    <div class="day-number">22</div>
                                </div>
                                <div class="calendar-day">
                                    <div class="day-name">TUE</div>
                                    <div class="day-number">23</div>
                                </div>
                                <div class="calendar-day">
                                    <div class="day-name">WED</div>
                                    <div class="day-number">24</div>
                                </div>
                                <div class="calendar-day">
                                    <div class="day-name">THU</div>
                                    <div class="day-number">25</div>
                                </div>
                                <div class="calendar-day">
                                    <div class="day-name">FRI</div>
                                    <div class="day-number">26</div>
                                </div>
                                <div class="calendar-day">
                                    <div class="day-name">SAT</div>
                                    <div class="day-number">27</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
            
            <!-- Course Preview Modal -->
            <div id="coursePreviewModal" class="preview-modal">
                <div class="modal-overlay" onclick="closePreviewModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="modalCourseTitle">Course Preview</h3>
                        <button class="modal-close" onclick="closePreviewModal()">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="course-sections-list" id="courseSectionsList">
                            <!-- Sections will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        {{/middle}}
    
    {{#middle}}
    <script>
    let currentCourseIndex = 0;
    const courses = document.querySelectorAll('.middle-course-card');
    const indicators = document.querySelectorAll('.indicator');
    
    function showCourse(index) {
        // Hide all courses
        courses.forEach(course => {
            course.style.display = 'none';
        });
        
        // Show current course
        if (courses[index]) {
            courses[index].style.display = 'block';
        }
        
        // Update indicators
        indicators.forEach((indicator, i) => {
            indicator.classList.toggle('active', i === index);
        });
        
        // Navigation buttons are always enabled for circular navigation
        const prevBtn = document.querySelector('.prev-btn');
        const nextBtn = document.querySelector('.next-btn');
        
        if (prevBtn) prevBtn.style.opacity = '1';
        if (nextBtn) nextBtn.style.opacity = '1';
    }
    
    function changeCourse(direction) {
        if (courses.length === 0) return;
        
        if (direction === 1) {
            // Move to next course (circular)
            currentCourseIndex = (currentCourseIndex + 1) % courses.length;
        } else {
            // Move to previous course (circular)
            currentCourseIndex = (currentCourseIndex - 1 + courses.length) % courses.length;
        }
        
        showCourse(currentCourseIndex);
    }
    
    function goToCourse(index) {
        if (index >= 0 && index < courses.length) {
            currentCourseIndex = index;
            showCourse(currentCourseIndex);
        }
    }
    
    // Initialize carousel
    document.addEventListener('DOMContentLoaded', function() {
        if (courses.length > 0) {
            showCourse(0);
        }
    });
    
    // Modal functionality
    function openPreviewModal(courseId, courseName) {
        const modal = document.getElementById('coursePreviewModal');
        const modalTitle = document.getElementById('modalCourseTitle');
        const sectionsList = document.getElementById('courseSectionsList');
        
        // Set modal title
        modalTitle.textContent = courseName + ' - Course Sections';
        
        // Show loading state
        sectionsList.innerHTML = '<div class="loading-spinner"><i class="fa fa-spinner fa-spin"></i> Loading sections...</div>';
        
        // Show modal
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Load course sections via AJAX
        loadCourseSections(courseId, sectionsList);
    }
    
    function closePreviewModal() {
        const modal = document.getElementById('coursePreviewModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    function loadCourseSections(courseId, container) {
        // Create a simple AJAX request to load sections
        // For now, we'll simulate the data structure
        const sections = [
            { id: 1, name: 'Introduction to Digital Learning', description: 'Welcome to the course and overview of digital tools', activities: 3 },
            { id: 2, name: 'Basic Computer Skills', description: 'Learning fundamental computer operations', activities: 5 },
            { id: 3, name: 'Digital Safety and Security', description: 'Understanding online safety and privacy', activities: 4 },
            { id: 4, name: 'Creative Digital Projects', description: 'Hands-on projects using digital tools', activities: 6 },
            { id: 5, name: 'Assessment and Review', description: 'Final assessment and course review', activities: 2 }
        ];
        
        // Clear loading state
        container.innerHTML = '';
        
        // Add sections to the modal
        sections.forEach(section => {
            const sectionElement = document.createElement('div');
            sectionElement.className = 'section-item';
            sectionElement.innerHTML = `
                <div class="section-header">
                    <h4 class="section-name">${section.name}</h4>
                    <span class="section-activities">${section.activities} activities</span>
                </div>
                <p class="section-description">${section.description}</p>
            `;
            container.appendChild(sectionElement);
        });
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('coursePreviewModal');
        if (e.target === modal) {
            closePreviewModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePreviewModal();
        }
    });

    // Real-time course count update functions
    function refreshCourseCount() {
        console.log('refreshCourseCount called'); // Debug log
        const refreshIcon = document.getElementById('courses-refresh-icon');
        const coursesCount = document.getElementById('total-courses-count');
        const coursesUpdated = document.getElementById('courses-updated');

        if (!refreshIcon || !coursesCount || !coursesUpdated) {
            console.error('Required elements not found:', {refreshIcon, coursesCount, coursesUpdated});
            return;
        }

        // Show loading state
        refreshIcon.classList.add('fa-spin');
        console.log('Fetching data from: {{config.wwwroot}}/test_ajax.php'); // Debug log

        // Fetch real-time data
        fetch('{{config.wwwroot}}/test_ajax.php')
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.text(); // Get as text first
            })
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    if (data.status === 'success') {
                        // Update the count with animation
                        animateCountUpdate(coursesCount, data.total_courses);
                        coursesUpdated.textContent = 'Last updated: ' + data.timestamp;

                        // Show success feedback
                        showUpdateFeedback('courses-card', 'success');
                    } else {
                        console.error('API Error:', data);
                        showUpdateFeedback('courses-card', 'error');
                    }
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response text:', text);
                    showUpdateFeedback('courses-card', 'error');
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                showUpdateFeedback('courses-card', 'error');
            })
            .finally(() => {
                // Remove loading state
                refreshIcon.classList.remove('fa-spin');
            });
    }

    function animateCountUpdate(element, newValue) {
        const currentValue = parseInt(element.textContent) || 0;
        const increment = newValue > currentValue ? 1 : -1;
        const duration = 1000; // 1 second
        const steps = Math.abs(newValue - currentValue);
        const stepDuration = duration / steps;

        let currentStep = 0;
        const timer = setInterval(() => {
            currentStep++;
            const newDisplayValue = currentValue + (increment * currentStep);
            element.textContent = newDisplayValue;

            if (currentStep >= steps) {
                clearInterval(timer);
                element.textContent = newValue;
            }
        }, stepDuration);
    }

    function showUpdateFeedback(cardId, type) {
        const card = document.getElementById(cardId);
        const feedback = document.createElement('div');
        feedback.className = `update-feedback ${type}`;
        feedback.textContent = type === 'success' ? '✓ Updated' : '✗ Error';
        feedback.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: ${type === 'success' ? '#4CAF50' : '#f44336'};
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        `;

        card.style.position = 'relative';
        card.appendChild(feedback);

        // Fade in
        setTimeout(() => feedback.style.opacity = '1', 10);

        // Fade out and remove
        setTimeout(() => {
            feedback.style.opacity = '0';
            setTimeout(() => card.removeChild(feedback), 300);
        }, 2000);
    }

    // Auto-refresh course count every 30 seconds
    setInterval(refreshCourseCount, 30000);

    // Middle school course count refresh function
    function refreshMiddleCourseCount() {
        console.log('refreshMiddleCourseCount called'); // Debug log
        const refreshIcon = document.getElementById('middle-courses-refresh-icon');
        const coursesCount = document.getElementById('middle-total-courses-count');
        const coursesUpdated = document.getElementById('middle-courses-updated');

        if (!refreshIcon || !coursesCount || !coursesUpdated) {
            console.error('Required elements not found:', {refreshIcon, coursesCount, coursesUpdated});
            return;
        }

        // Show loading state
        refreshIcon.classList.add('fa-spin');
        console.log('Fetching data from: {{config.wwwroot}}/test_ajax.php'); // Debug log

        // Fetch real-time data
        fetch('{{config.wwwroot}}/test_ajax.php')
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.text(); // Get as text first
            })
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    if (data.status === 'success') {
                        // Update the count with animation
                        animateCountUpdate(coursesCount, data.total_courses);
                        coursesUpdated.textContent = 'Last updated: ' + data.timestamp;

                        // Show success feedback
                        showUpdateFeedback('middle-courses-card', 'success');
                    } else {
                        console.error('API Error:', data);
                        showUpdateFeedback('middle-courses-card', 'error');
                    }
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response text:', text);
                    showUpdateFeedback('middle-courses-card', 'error');
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                showUpdateFeedback('middle-courses-card', 'error');
            })
            .finally(() => {
                // Remove loading state
                refreshIcon.classList.remove('fa-spin');
            });
    }

    // Auto-refresh middle school course count every 30 seconds
    setInterval(refreshMiddleCourseCount, 30000);

    // Debug function to test AJAX endpoint
    function testAjaxEndpoint() {
        console.log('Testing AJAX endpoint...');
        fetch('{{config.wwwroot}}/test_ajax.php')
            .then(response => {
                console.log('Response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('Raw response:', text);
                try {
                    const data = JSON.parse(text);
                    console.log('Parsed data:', data);
                    alert('AJAX Test Result: ' + JSON.stringify(data, null, 2));
                } catch (e) {
                    console.error('JSON parse error:', e);
                    alert('JSON Parse Error: ' + e.message + '\nRaw response: ' + text);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Fetch Error: ' + error.message);
            });
    }

    // Add test button for debugging
    document.addEventListener('DOMContentLoaded', function() {
        // Add a test button for debugging (remove this in production)
        const testButton = document.createElement('button');
        testButton.textContent = 'Test AJAX';
        testButton.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; background: #007bff; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;';
        testButton.onclick = testAjaxEndpoint;
        document.body.appendChild(testButton);
        
        console.log('Dashboard loaded, AJAX functions available');
    });
    </script>
    {{/middle}}
    
    {{#highschool}}
        <div class="highschool-dashboard">
            <div class="row">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fa fa-trophy"></i> High School Dashboard</h5>
                        </div>
                        <div class="card-body">
                            <p>This is an advanced dashboard for high school students (Grades 8-12).</p>
                            <p>Features will include:</p>
                            <ul>
                                <li>Comprehensive academic tracking</li>
                                <li>College preparation tools</li>
                                <li>Advanced analytics and reporting</li>
                                <li>Career planning resources</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {{/highschool}}
    
    {{#default}}
        <div class="default-dashboard">
            <div class="row">
                <div class="col-12">
                    <div class="card border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0"><i class="fa fa-home"></i> Default Dashboard</h5>
                        </div>
                        <div class="card-body">
                            <p>This is the default dashboard for users not assigned to specific grade cohorts.</p>
                            <p>You can customize this dashboard or assign users to appropriate grade cohorts.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {{/default}}
{{/dashboard_type}}

{{/custom_dashboard}}

<!-- Regular Dashboard Content -->
<div class="dashboard-content">
    <div id="region-main-box" class="d-print-block">
        <section id="region-main" class="d-print-block" aria-label="{{#str}}content{{/str}}">
            <div class="rui-course-content">
                {{{ output.main_content }}}
            </div>
        </section>
    </div>
</div>

{{> theme_remui/common_end}}
